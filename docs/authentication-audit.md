# Audit du système d'authentification

## Points forts observés
- Le garde global du routeur attend que le store d'authentification soit initialisé et filtre les chemins de redirection pour n'autoriser que des routes internes, limitant ainsi les risques d'accès non autorisé ou de redirections ouvertes.【F:src/router/index.ts†L142-L170】
- Lors de l'inscription, l'application transmet à Supabase une URL de rappel dérivée de l'origine courante et filtre la valeur `redirect`, ce qui évite l'injection d'URL externes dans les liens envoyés par e-mail.【F:src/stores/authStore.ts†L114-L139】
- Le client Supabase lève explicitement une erreur si les identifiants sont absents en dehors des tests, évitant l'utilisation involontaire d'un backend non sécurisé ou d'un mock en production.【F:src/lib/supabase.ts†L229-L268】

## Risques et améliorations recommandées
| Risque | Impact | Recommandation |
| --- | --- | --- |
| **Initialisation non robuste du store** : `loadInitialSession` marque l'authentification comme initialisée dans le bloc `finally`, même si `supabase.auth.getSession()` lève une exception réseau ; les prochains appels ne retenteront plus la récupération de session et l'état restera bloqué en échec silencieux.【F:src/stores/authStore.ts†L49-L69】 | Les utilisateurs peuvent rester déconnectés après une panne transitoire ou voir le garde de route tourner indéfiniment sans possibilité de récupération automatique. | Envelopper `getSession()` dans un `try/catch` explicite, conserver `isInitialized` à `false` tant que la récupération n'a pas abouti et exposer une méthode de réinitialisation pour retenter automatiquement après un délai ou sur action utilisateur. |
| **Gestion d'erreurs hétérogène pour la vérification d'e-mail** : en l'absence d'adresse e-mail connue, `resendEmailVerification` renvoie une instance générique de `Error` qui n'est pas alignée sur la forme des erreurs Supabase, ce qui complique l'affichage cohérent des messages et l'internationalisation.【F:src/stores/authStore.ts†L205-L220】 | Les composants consommateurs ne peuvent pas distinguer ce cas des autres erreurs Supabase et risquent d'afficher un message technique au lieu d'un retour utilisateur adapté. | Retourner un objet aligné sur `AuthError` (avec `status` et `message` localisable) ou déplacer cette validation côté interface pour afficher un message utilisateur avant d'appeler l'API. |
| **Renouvellement de session après mise à jour sensible** : `updateProfile` applique localement l'utilisateur renvoyé mais n'actualise pas la session ni ne force la reconnexion après un changement de mot de passe.【F:src/stores/authStore.ts†L166-L192】 | La session courante peut rester active avec d'anciens jetons, ce qui retarde l'application de certaines politiques de sécurité (ex. révocation des anciens tokens) et ne protège pas contre la réutilisation d'une session compromise. | Après une mise à jour incluant un mot de passe, demander explicitement une reconnexion ou déclencher `refreshSession()`/`signOut()` pour forcer l'utilisateur à se reconnecter avec les nouvelles informations. |
| **Arrêt limité de l'écouteur d'état** : l'écouteur d'événements Supabase n'est désinscrit qu'à la fermeture de l'onglet (`beforeunload`), ce qui peut laisser des abonnements multiples lors d'un montage/démontage répété dans des contextes de tests ou de navigation multi-instance.【F:src/stores/authStore.ts†L24-L43】【F:src/stores/authStore.ts†L222-L227】 | Multiplication des appels à `applySession`, fuites mémoire potentielles et difficultés de diagnostic dans les tests unitaires ou lors d'un rendu côté serveur. | Exposer `stopAuthListener()` publiquement et l'invoquer lors du démontage des composants clés (ou utiliser l'API de Pinia pour nettoyer automatiquement) afin de garantir qu'un seul abonnement actif reste présent. |

## Opportunités supplémentaires
- Centraliser la journalisation des erreurs Supabase et fournir des messages localisés prêts à l'emploi pour maintenir une UX cohérente lorsque `lastError` est alimenté par des messages techniques.【F:src/stores/authStore.ts†L95-L163】
- Ajouter des tests d'intégration simulant des coupures réseau pour valider le comportement recommandé ci-dessus et documenter les procédures de reprise dans le guide développeur.【F:src/stores/authStore.ts†L49-L74】
